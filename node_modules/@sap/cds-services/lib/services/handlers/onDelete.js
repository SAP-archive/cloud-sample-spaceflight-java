const notFound = require('./notFound')

const _getSelectCQN = (context) => {
  const select = context.statements.SELECT.from(context.target)
  select.SELECT.where = context.query.DELETE.where

  return select
}

/**
 * Generic Handler for DELETE requests.
 * In case of success it returns an empty object.
 * If the entry to be deleted does not exist, it rejects with error to return a 404.
 *
 * @param context - operation object, that provides error, continuation and other functions as well as information
 * regarding the current operation.
 * @alias module:handlers.onDelete
 */
const onDelete = (context) => {
  if (!context.run) {
    return Promise.resolve()
  }

  return context.run(_getSelectCQN(context))
    .then((result) => {
      if (result.length === 0) {
        throw notFound(context)
      }

      context._oldData = result[0]

      return context.run(context.query)
        .then(() => {})
    })
}

module.exports = onDelete
