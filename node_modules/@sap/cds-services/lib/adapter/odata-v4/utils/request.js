const {
  QueryOptions,
  uri: {
    UriResource: {
      ResourceKind: {
        NAVIGATION_TO_MANY
      }
    }
  }
} = require('@sap/odata-v4')

const _unboundActionsAndFunctions = ['ACTION.IMPORT', 'FUNCTION.IMPORT']
const _actionsAndFunctions = [..._unboundActionsAndFunctions, 'BOUND.FUNCTION']

/**
 * Checks if a custom operation was requested.
 * @param {Array} pathSegments - The uri path segments of the request.
 * @param {boolean} [includingBound] - True if the check should also accept bound operations. Default is true.
 * @returns {boolean} - True if the request targets a custom operation.
 * @private
 */
const isCustomOperation = (pathSegments, includingBound = true) => {
  const customOperationKinds = (includingBound) ? _actionsAndFunctions : _unboundActionsAndFunctions

  return customOperationKinds.includes(pathSegments[pathSegments.length - 1].getKind())
}

/**
 * Get the maximal page size.
 * @param {Array} segments
 * @return {number}
 * @private
 */
const maxPageSize = (segments) => {
  // Only last segment can hold the page size
  const lastSegment = segments[segments.length - 1]
  const entitySet = lastSegment.getEntitySet()

  if (entitySet) {
    return entitySet.getMaxPageSize()
  }

  return (lastSegment.getKind() === NAVIGATION_TO_MANY) ? lastSegment.getTarget().getMaxPageSize() : undefined
}

/**
 * Validate resource path length.
 * It will throw an error in case the maximum is exceeded.
 * @param {Object} req odata request
 * @param {Object} options odata configuration options
 */
const validateResourcePathLength = (req, options) => {
  const {getError} = require('../../../errors')

  if (req.getUriInfo().getPathSegments().length > options.maxResourcePathLength) {
    throw getError(400, `Maximum number of resource path segments is ${options.maxResourcePathLength}`)
  }
}

/**
 * Used for pagination, where the start of the collection is defined via skip token.
 * @param {Object} uriInfo
 * @return {number}
 * @private
 */
const skipToken = (uriInfo) => {
  const token = uriInfo.getQueryOption(QueryOptions.SKIPTOKEN)

  // If given, the token is a string but needed as numeric value.
  return (token) ? parseInt(token) : 0
}

module.exports = {
  isCustomOperation,
  maxPageSize,
  validateResourcePathLength,
  skipToken
}
