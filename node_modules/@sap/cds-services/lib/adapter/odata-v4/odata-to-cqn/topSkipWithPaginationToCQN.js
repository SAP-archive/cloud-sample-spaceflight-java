const {maxPageSize, skipToken} = require('../utils/request')

const _getOffset = (offset, incomingSkipToken) => {
  return (offset || 0) + incomingSkipToken
}

const _getMaxRows = (rows, maxPageSize, incomingSkipToken) => {
  if (incomingSkipToken > 0) {
    const tooMuch = rows - maxPageSize

    if (tooMuch < 1) {
      return rows
    }

    if (tooMuch > maxPageSize) {
      return maxPageSize
    }

    return tooMuch
  }

  if (rows > maxPageSize) {
    return maxPageSize
  }

  return rows || 0
}

/**
 * Add pagination params to cqn
 * @param {Object} req - odata-v4 request
 * @param {Object} cqn - CQN Object
 */
const topSkipWithPaginationToCQN = (req, cqn) => {
  //, maxPageSize, incomingSkipToken
  const uriInfo = req.getUriInfo()
  const pageSize = maxPageSize(uriInfo.getPathSegments())

  if (!pageSize) {
    return
  }

  const incomingSkipToken = skipToken(uriInfo)
  const limit = cqn.SELECT.limit

  if (limit) {
    const rows = _getMaxRows(limit.rows ? limit.rows.val : undefined, pageSize, incomingSkipToken)
    const offset = _getOffset(limit.offset ? limit.offset.val : undefined, incomingSkipToken)

    cqn.SELECT.limit = {rows: rows ? {val: rows} : undefined, offset: offset ? {val: offset} : undefined}

    return
  }

  cqn.SELECT.limit = {
    rows: {val: pageSize},
    offset: incomingSkipToken ? {val: incomingSkipToken} : undefined
  }
}

module.exports = topSkipWithPaginationToCQN
