const BaseBuilder = require('./BaseBuilder')

/**
 * DeleteBuilder is used to take a CQN object as an input and to build an object representing a delete operation
 * with SQL string and values to be used with a prepared statement.
 * The SQL object can only be built if the property 'from' is available.
 * The property 'where' is optional.
 * @example <caption>Example of CQN </caption>
 * {
 *  DELETE = {DELETE:{
 *  from: entity | string,
 *  where: _xpr
 *  }}
 * }
 */
class DeleteBuilder extends BaseBuilder {
  get ExpressionBuilder () {
    const ExpressionBuilder = require('./ExpressionBuilder')
    Object.defineProperty(this, 'ExpressionBuilder', {value: ExpressionBuilder})
    return ExpressionBuilder
  }

  /**
   * Builds an Object based on the properties of the CQN object.
   * @example <caption>Example output</caption>
   * {
   *    sql: 'DELETE FROM "T" WHERE "COLUMN" = ?',
   *    values: [1]
   * }
   *
   * @returns {{sql: string, values: Array}} Object with two properties.
   * SQL string for prepared statement and array of values to replace the placeholders.
   */
  build () {
    this._outputObj = {
      sql: ['DELETE'],
      values: []
    }
    this._options.entityNames.push(this._obj.DELETE.from.name || this._obj.DELETE.from)
    this._from()
    if (this._obj.DELETE.hasOwnProperty('where')) {
      this._where()
    }

    this._outputObj.sql = this._outputObj.sql.join(' ')
    return this._outputObj
  }

  _from () {
    this._outputObj.sql.push('FROM')
    if (typeof this._obj.DELETE.from === 'string') {
      this._outputObj.sql.push(this._quoteElement(this._obj.DELETE.from))
    } else {
      this._outputObj.sql.push(this._quoteElement(this._obj.DELETE.from.name))
    }
  }

  _where () {
    const where = new this.ExpressionBuilder(this._obj.DELETE.where, this._options).build()
    this._outputObj.sql.push('WHERE', where.sql)
    this._outputObj.values = where.values
  }
}

module.exports = DeleteBuilder
