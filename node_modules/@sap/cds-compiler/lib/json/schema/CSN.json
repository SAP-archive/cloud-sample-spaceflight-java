//Notes:
// - top level definitions have additional property "this", which equals to the definition name.
//   It is used produce appropriate error messages.
{
  "type": "object",
  "properties": {
    "definitions": {
      "type": "object",
      "patternProperties": {
        ".+": {
          "$ref": "#/schemas/definition"
        }
      },
      "additionalProperties": false
    },
    "messages": {
      "type": "array"
    },
    "version": {
      "type": "object",
      "properties": {
        "csn": {
          "type": "string"
        },
        "creator": {
          "type": "string"
        }
      },
      "required": [
        "csn"
      ],
      "additionalProperties": false
    }
  },
  "required": [
    "definitions"
  ],
  "patternProperties": {
    "^@.+": {
      "$ref": "#/schemas/annotationAssignment"
    }
  },
  "additionalProperties": false,
  "schemas": {
    "definition": {
      "oneOf": [
        {
          "$ref": "#/schemas/typeDefinition"
        },
        {
          "$ref": "#/schemas/entityDefinition"
        },
        {
          "$ref": "#/schemas/viewDefinition"
        },
        {
          "$ref": "#/schemas/constDefinition"
        },
        {
          "$ref": "#/schemas/annotationDefinition"
        },
        {
          "$ref": "#/schemas/contextDefinition"
        },
        {
          "$ref": "#/schemas/serviceDefinition"
        },
        {
          "$ref": "#/schemas/actionDefinition"
        },
        {
          "$ref": "#/schemas/functionDefinition"
        },
        {
          "$ref": "#/schemas/roleDefinition"
        },
        {
          "$ref": "#/schemas/aspectDefinition"
        },
        {
          "$ref": "#/schemas/accesspolicyDefinition"
        }
      ]
      // TODO: accesspolicy,role,const,aspect for HANA CDS"
    },
    "constDefinition": {
      "this": "constDefinition",
      "type": "object",
      "properties": {
        "kind": {
          "const": "const"
        },
        "type": {
          "type": "string"
        },
        "value": {
          "$ref": "#/schemas/genericValue"
        },
        "length": {
          "type": "integer"
        },
        "precision": {
          "type": "integer"
        },
        "scale": {
          "type": "integer"
        }
      },
      "required": [
        "kind"
      ],
      "patternProperties": {
        "^@.+": {
          "$ref": "#/schemas/annotationAssignment"
        }
      },
      "additionalProperties": false
    },
    "contextDefinition": {
      "this": "contextDefinition",
      "type": "object",
      "properties": {
        "kind": {
          "const": "context"
        }
      },
      "required": [
        "kind"
      ],
      "patternProperties": {
        "^@.+": {
          "$ref": "#/schemas/annotationAssignment"
        }
      },
      "additionalProperties": false
    },
    "serviceDefinition": {
      "this": "serviceDefinition",
      "type": "object",
      "properties": {
        "kind": {
          "const": "service"
        },
        "actions": {
          "$ref": "#/schemas/actions"
        }
      },
      "required": [
        "kind"
      ],
      "patternProperties": {
        "^@.+": {
          "$ref": "#/schemas/annotationAssignment"
        }
      },
      "additionalProperties": false
    },
    "roleDefinition": {
      "this": "roleDefinition",
      "type": "object",
      "properties": {
        "kind": {
          "const": "role"
        }
      },
      "required": [
        "kind"
      ],
      "patternProperties": {
        "^@.+": {
          "$ref": "#/schemas/annotationAssignment"
        }
      },
      "additionalProperties": false
    },
    "aspectDefinition": {
      "this": "aspectDefinition",
      "type": "object",
      "properties": {
        "kind": {
          "const": "aspect"
        },
        // TODO: for HANA CDS
        "query": {
          "type": "object"
        }
      },
      "required": [
        "kind"
        //"query" TODO aspect definition without query?
      ],
      "patternProperties": {
        "^@.+": {
          "$ref": "#/schemas/annotationAssignment"
        }
      },
      "additionalProperties": false
    },
    "accesspolicyDefinition": {
      "this": "accesspolicyDefinition",
      "type": "object",
      "properties": {
        "kind": {
          "const": "accesspolicy"
        }
      },
      "required": [
        "kind"
      ],
      "patternProperties": {
        "^@.+": {
          "$ref": "#/schemas/annotationAssignment"
        }
      },
      "additionalProperties": false
    },
    "functionDefinition": {
      "this": "functionDefinition",
      "type": "object",
      "properties": {
        "kind": {
          "const": "function"
        },
        "params": {
          "$ref": "#/schemas/actionParams"
        },
        "returns": {
          "$ref": "#/schemas/actionReturns"
        }
      },
      "required": [
        "kind",
        "returns"
      ],
      "patternProperties": {
        "^@.+": {
          "$ref": "#/schemas/annotationAssignment"
        }
      },
      "additionalProperties": false
    },
    "actionDefinition": {
      "this": "actionDefinition",
      "type": "object",
      "properties": {
        "kind": {
          "const": "action"
        },
        "params": {
          "$ref": "#/schemas/actionParams"
        },
        "returns": {
          "$ref": "#/schemas/actionReturns"
        }
      },
      "required": [
        "kind"
      ],
      "patternProperties": {
        "^@.+": {
          "$ref": "#/schemas/annotationAssignment"
        }
      },
      "additionalProperties": false
    },
    "queryComplex": {
      "this": "queryComplex",
      "type": "object",
      "properties": {
        "op": {
          "type": "string"
        },
        "all": {
          "type": "boolean"
        },
        "query": {
          "$ref": "#/schemas/query"
        },
        "query2": {
          "$ref": "#/schemas/query"
        }
      },
      "additionalProperties": false
    },
    "querySimple": {
      "type": "object",
      "properties":{
        "kind": {
          "const": "query"
        }
      },
      "additionalProperties": false
    },
    "query": { // TODO: improve
      "oneOf":[
        {
          "$ref": "#/schemas/querySimple"
        },
        {
          "$ref": "#/schemas/queryComplex"
        }
      ]
    },
    "viewDefinition": {
      "this": "viewDefinition",
      "type": "object",
      "properties": {
        "kind": {
          "const": "view"
        },
        "query": {
//          "$ref": "#/schemas/query"
          "type": [ // TODO improve
            "object",
            "array"
          ]
        },
        "queries": { // TODO: delete later?
          "type": "array"
        },
        "elements": {
          "$ref": "#/schemas/elements"
        },
        "items": {
          "$ref": "#/schemas/items"
        },
        "params": {
          "$ref": "#/schemas/viewParams"
        },
        "source": {
          "type": "string"
        },
        "target": {
          "type": "string"
        }
      },
      "required": [
        "kind"
        //"query" TODO view definition without query allowed?
      ],
      "patternProperties": {
        "^@.+": {
          "$ref": "#/schemas/annotationAssignment"
        }
      },
      "additionalProperties": false
    },
    "annotationDefinition": {
      "this": "annotationDefinition",
      "type": "object",
      "properties": {
        "kind": {
          "const": "annotation"
        },
        "type": {
          "type": "string"
        },
        "length": {
          "type": "integer"
        },
        "elements": {
          "$ref": "#/schemas/elements"
        },
        "items": {
          "$ref": "#/schemas/items"
        },
        "enum": {
          "$ref": "#/schemas/enum"
        },
        "localized": {
          "type": "boolean"
        }
      },
      "required": [
        "kind"
      ],
      "patternProperties": {
        "^@.+": {
          "$ref": "#/schemas/annotationAssignment"
        }
      },
      "additionalProperties": false
    },
    "entityDefinition": {
      "this": "entityDefinition",
      "type": "object",
      "properties": {
        "kind": {
          "const": "entity"
        },
        "type": {
          "type": "string"
        },
        "length": {
          "type": "integer"
        },
        "elements": {
          "$ref": "#/schemas/elements"
        },
        "items": {
          "$ref": "#/schemas/items"
        },
        "precision": {
          "type": "integer"
        },
        "scale": {
          "type": "integer"
        },
        "impl": {
          "type": "string"
        },
        "params": {
          "$ref": "#/schemas/actionParams"
        },
        "query": { // TODO: improve
          "type": "object"
        },
        "queries": { // TODO: delete later?
          "type": "array"
        },
        "source": {
          "type": "string"
        },
        "target": {
          "type": "string"
        },
        "actions": {
          "$ref": "#/schemas/actions"
        },
        "includes": {
          "type": "array",
          "items": {
            "$ref": "#/schemas/includesItem"
          },
          "additionalItems": false
        },
        "abstract": {
          "type": "boolean"
        },
        "arrayed": {
          "type": "boolean"
        },
        "enum": {
          "$ref": "#/schemas/enum"
        },
        // TODO: for HANA CDS
        "dbType": {
          "type": "boolean"
        },
        // TODO: for HANA CDS
        "temporary": {
          "type": "object",
          "properties": {
            "val": {
              "type": "boolean"
            }
          },
          "additionalProperties": false
        },
        "localized": {
          "type": "boolean"
        }
      },
      "required": [
        "kind"
      ],
      "patternProperties": {
        "^@.+": {
          "$ref": "#/schemas/annotationAssignment"
        }
      },
      "additionalProperties": false
    },
    "typeDefinition": {
      "this": "typeDefinition",
      "type": "object",
      "properties": {
        "kind": {
          "const": "type",
          "default": "type"
        },
        "type": {
          "type": "string"
        },
        "length": {
          "type": "integer"
        },
        "elements": {
          "$ref": "#/schemas/elements"
        },
        "items": {
          "$ref": "#/schemas/items"
        },
        "precision": {
          "type": "integer"
        },
        "scale": {
          "type": "integer"
        },
        "impl": {
          "type": "string"
        },
        "params": {
          "$ref": "#/schemas/actionParams"
        },
        "target": {
          "type": "string"
        },
        "foreignKeys": {
          "type": "object"
        },
        "includes": {
          "type": "array",
          "items": {
            "$ref": "#/schemas/includesItem"
          },
          "additionalItems": false
        },
        "abstract": {
          "type": "boolean"
        },
        "arrayed": {
          "type": "boolean"
        },
        "enum": {
          "$ref": "#/schemas/enum"
        },
        "dbType": { // TODO: for HANA CDS
          "type": "boolean"
        },
        "temporary": {
          "type": "object", // TODO: for HANA CDS
          "properties": {
            "val": {
              "type": "boolean"
            }
          },
          "additionalProperties": false
        },
        "localized": {
          "type": "boolean"
        }
      },
      "patternProperties": {
        "^@.+": {
          "$ref": "#/schemas/annotationAssignment"
        }
      },
      "anyOf" : [
        {
          "required" : ["elements"]
        },
        {
          "required" : ["type"]
        },
        {
          "required" : ["enum"]
        },
        {
          "required" : ["items"]
        },
        {
          "required" : ["kind","type"]
        },
        {
          "required" : ["kind","elements"]
        }
      ],
      "additionalProperties": false
    },
    "viewParams": {
      "type": "object",
      "patternProperties": {
        ".+": {
          "$ref": "#/schemas/viewParam"
        }
      },
      "additionalProperties": false
    },
    "viewParam": {
      "type": "object",
      "properties": {
        "kind": {
          "const": "param"
        },
        "type": {
          "type": "string"
        },
        "length": {
          "type": "integer"
        },
        "indexNo": {
          "type": "integer"
        }
      },
      "patternProperties": {
        "^@.+": {
          "$ref": "#/schemas/annotationAssignment"
        }
      },
      "additionalProperties": false
    },
    "elements": {
      "type": "object",
      "patternProperties": {
        ".+": {
          "$ref": "#/schemas/element"
        }
      },
      "additionalProperties": false
    },
    "element": {
      "type": "object",
      "properties": {
        "_typeIsExplicit": { //TODO check this later again
          "type": "boolean"
        },
        "type": {
          "type": "string"
        },
        "key": {
          "type": "boolean"
        },
        "length": {
          "type": "integer"
        },
        "indexNo": {
          "type": "integer"
        },
        "precision": {
          "type": "integer"
        },
        "scale": {
          "type": "integer"
        },
        "items": {
          "$ref": "#/schemas/items"
        },
        "elements": {
          "$ref": "#/schemas/elements"
        },
        "enum": {
          "$ref": "#/schemas/enum"
        },
        "origin": {
          "$ref": "#/schemas/origin"
        },
        "on": {
          "type": "string"
        },
        "onCond": {
          "$ref": "#/schemas/associationCondition"
        },
        "target": {
          "type": "string"
        },
        "alias": {
          "type": "string"
        },
        "localized": {
          "type": "boolean"
        },
        "masked": {
          "type": "boolean"
        },
        "notNull": {
          "type": "boolean"
        },
        "not null": { // TODO: for TNT
          "type": "boolean"
        },
        "foreignKeys": {
          "type": "object"
        },
        "arrayed": {
          "type": "boolean"
        },
        "virtual": {
          "type": "boolean"
        },
        "default": {
          "type": [
            "string",
            "object",
            "boolean",
            "integer",
            "null",
            "array"
          ],
          "properties": {
            "=": {
              "type": "string"
            }
          }
        },
        "redirected": { // TODO: for TNT
          "type": "boolean"
        },
        "cardinality": {
          "type": [
            "object",
            "array"
          ],
          "properties": {
            "targetMin": {
              "type": [
                "integer",
                "string"
              ]
            },
            "targetMax": {
              "type": [
                "integer",
                "string"
              ]
            },
            "sourceMax": {
              "type": [
                "integer",
                "string"
              ]
            }
          },
          "additionalProperties": false
        },
        "value": {
          "type": [
            "boolean", // TODO check views with "<boolean|number|string> as select_item"
            "string",
            "integer",
            "null",
            "array",
            "object" // TODO improve, has op,args
          ]
        }
      },
      "patternProperties": {
        "^@.+": {
          "$ref": "#/schemas/annotationAssignment"
        }
      },
      "additionalProperties": false
    },
    "items": {
      "oneOf": [
        {
          "$ref": "#/schemas/simpleItem"
        },
        {
          "$ref": "#/schemas/directElements"
        }
      ]
    },
    "basicTypes": {
      "string": {
        "type": "object",
        "properties": {
          "type": {
            "type": "string"
          },
          "length": {
            "type": "integer"
          },
          "enum": {
            "$ref": "#/schemas/enum"
          }
        },
        "required": [
          "type"
        ],
        "additionalProperties": false
      },
      "integer": {
        "type": "object",
        "properties": {
          "type": {
            "type": "string"
          }
        },
        "required": [
          "type"
        ],
        "additionalProperties": false
      },
      "decimal": {
        "type": "object",
        "properties": {
          "type": {
            "type": "string"
          },
          "precision": {
            "type": "integer"
          },
          "scale": {
            "type": "integer"
          }
        },
        "required": [
          "type"
        ],
        "additionalProperties": false
      }
    },
    "basicType": {
      "anyOf": [
        {
          "$ref": "#/schemas/basicTypes/string"
        },
        {
          "$ref": "#/schemas/basicTypes/integer"
        },
        {
          "$ref": "#/schemas/basicTypes/decimal"
        }
      ]
    },
    "simpleItem": {
      "$ref": "#/schemas/basicType"
    },
    "directElements": {
      "type": "object",
      "properties": {
        "elements": {
          "$ref": "#/schemas/elements"
        }
      },
      "required": [
        "elements"
      ],
      "additionalProperties": false
    },
    "genericValue": {
      "type": [
        "integer",
        "number",
        "string",
        "boolean",
        "object",
        "array",
        "null"
      ]
    },
    "annotationAssignment": {
      "type": [
        "integer",
        "number",
        "string",
        "boolean",
        "object",
        "array",
        "null"
      ]
    },
    "annotationWithAssignment": {
      "patternProperties": {
        "^@.+": {
          "$ref": "#/schemas/annotationAssignment"
        }
      }
    },
    "associationCondition": {
      "type": [
        "object",
        "array"
      ],
      "properties": {
        "args": {
          "type": "array",
          "items": {
            "$ref": "#/schemas/associationConditionArgument"
          },
          "additionalProperties": false
        },
        "op": {
          "type": "string"
        },
        "quantifier": {
          "type": "string"
        }
      },
      "required": [
        "op",
        "args"
      ],
      "additionalProperties": false
    },
    "actions": {
      "patternProperties": {
        ".+": {
          "oneOf": [
            {
              "$ref": "#/schemas/action"
            },
            {
              "$ref": "#/schemas/function"
            }
          ]
        }
      },
      "additionalProperties": false
    },
    "function": {
      "properties": {
        "kind": {
          "const": "function"
        },
        "params": {
          "$ref": "#/schemas/actionParams"
        },
        "returns": {
          "$ref": "#/schemas/actionReturns"
        }
      },
      "patternProperties": {
        "^@.+": {
          "$ref": "#/schemas/annotationAssignment"
        }
      },
      "required": [
        "returns"
      ],
      "additionalProperties": false
    },
    "action": {
      "properties": {
        "kind": {
          "const": "action"
        },
        "origin": { // TODO: for TNT - mocha test/testFromTNT.js -g TNT models Fully process simple TNT model
          "type": "string"
        },
        "params": {
          "$ref": "#/schemas/actionParams"
        },
        "returns": {
          "$ref": "#/schemas/actionReturns"
        }
      },
      "patternProperties": {
        "^@.+": {
          "$ref": "#/schemas/annotationAssignment"
        }
      },
      "additionalProperties": false
    },
    "actionParams": {
      "patternProperties": {
        ".+": {
          "$ref": "#/schemas/actionParam"
        }
      },
      "additionalProperties": false
    },
    "actionParam": {
      "properties": {
        "kind": {
          "enum": [
            "param"
          ]
        },
        "indexNo": {
          "type": "integer"
        },
        "length": {
          "type": "integer"
        },
        "type": {
          "type": "string"
        },
        "precision": {
          "type": "integer"
        },
        "scale": {
          "type": "integer"
        },
        "notNull": {
          "type": "boolean"
        },
        "not null": { // TODO: for TNT
          "type": "boolean"
        }
      },
      "patternProperties": {
        "^@.+": {
          "$ref": "#/schemas/annotationAssignment"
        }
      },
      "additionalProperties": false
    },
    "actionReturns": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string"
        },
        "length": {
          "type": "integer"
        },
        "elements": {
          "$ref": "#/schemas/elements"
        },
        "items": {
          "$ref": "#/schemas/items"
        },
        "enum": {
          "$ref": "#/schemas/enum"
        }
      },
      "additionalProperties": false
    },
    "enum": {
      "type": "object",
      "patternProperties": {
        ".+": {
          "$ref": "#/schemas/enumItem"
        }
      },
      "additionalProperties": false
    },
    "enumItem": {
      "type": "object",
      "properties": {
        "value": {
          "type": [
            "integer",
            "string",
            "boolean",
            "object",
            "array"
          ]
        },
        "kind": {
          "const": "enum",
          "default": "enum"
        }
      },
      "patternProperties": {
        "^@.+": {
          "$ref": "#/schemas/annotationAssignment"
        }
      },
      "additionalProperties": false
    },
    "origin": { // TODO: "why string for projections -> Zoo2.cds"
      "type": [
        "string",
        "object",
        "null" // TODO remove this
      ],
      "properties": {
        "absolute": {
          "type": "string"
        },
        "component": {
          "type": "string"
        }
      },
      "additionalProperties": false
    },
    "includesItem": {
      "oneOf": [
        {
          "$ref": "#/schemas/includesItemSimple"
        },
        {
          "$ref": "#/schemas/includesItemObject"
        }
      ]
    },
    "includesItemSimple": {
      "type": "string"
    },
    "includesItemObject": {
      "type": "object",
      "properties": {
        "absolute": {
          "type": "string"
        },
        "path": {
          "type": "string"
        }
      },
      "required": [
        "absolute",
        "path"
      ],
      "additionalProperties": false
    },
    "associationConditionArgument": {
      "oneOf": [
        {
          "type": "object",
          "properties": {
            "=": {
              "type": "string"
            },
            "#": {
              "type": "string"
            }
          },
          "additionalProperties": false
        },
        {
          "type": "object",
          "properties": {
            "args": {
              "type": "array",
              "items": {
                "$ref": "#/schemas/associationConditionArgument"
              }
            },
            "op": {
              "type": [
                "string",
                "null" // TODO: for HANA CDS
              ]
            },
            "func": {
              "type": "string"
            }
          },
          "additionalProperties": false
        },
        {
          "type": [
            "integer",
            "string",
            "array"
          ]
        }
      ]
    }
  }
}
